#! /bin/sh /usr/share/dpatch/dpatch-run
## 902_CVE-2009-3095.dpatch by Jamie Strandboge <jamie@ubuntu.com>
##
## DP: Description:
## DP:  Security fix - this is presumed to fix CVE-2009-3095 (the disclosed
## DP:  information was limited so this has not been confirmed):
## DP:  .
## DP:  * modules/proxy/mod_proxy_ftp.c (proxy_ftp_handler): Fail if the
## DP:    decoded Basic credentials contain "special" characters.
## DP:    Thanks to Stefan Fritsch for analysis of this issue.
## DP: Origin: http://svn.apache.org/viewvc?revision=814045&view=revision

@DPATCH@
diff -urNad apache2-2.2.12~/modules/proxy/mod_proxy_ftp.c apache2-2.2.12/modules/proxy/mod_proxy_ftp.c
--- apache2-2.2.12~/modules/proxy/mod_proxy_ftp.c	2009-11-12 13:40:24.971683328 -0600
+++ apache2-2.2.12/modules/proxy/mod_proxy_ftp.c	2009-11-12 13:40:30.101704208 -0600
@@ -912,6 +912,11 @@
     if ((password = apr_table_get(r->headers_in, "Authorization")) != NULL
         && strcasecmp(ap_getword(r->pool, &password, ' '), "Basic") == 0
         && (password = ap_pbase64decode(r->pool, password))[0] != ':') {
+        /* Check the decoded string for special characters. */
+        if (!ftp_check_string(password)) {
+            return ap_proxyerror(r, HTTP_BAD_REQUEST, 
+                                 "user credentials contained invalid character");
+        } 
         /*
          * Note that this allocation has to be made from r->connection->pool
          * because it has the lifetime of the connection.  The other
